name: "Update Helm chart versions in Chart.yaml files"

scms:
  github:
    kind: "github"
    spec:
      owner: "csepulveda"
      repository: "k8s-infra"
      branch: "main"
      token: "{{ requiredEnv `GITHUB_TOKEN` }}"

sources:
  certManagerChart:
    kind: helmchart
    spec:
      name: cert-manager
      url: https://charts.jetstack.io

  externalDnsChart:
    kind: helmchart
    spec:
      name: external-dns
      url: https://kubernetes-sigs.github.io/external-dns

  lokiChart:
    kind: helmchart
    spec:
      name: loki
      url: https://grafana.github.io/helm-charts

  promtailChart:
    kind: helmchart
    spec:
      name: promtail
      url: https://grafana.github.io/helm-charts

  gpuOperatorChart:
    kind: helmchart
    spec:
      name: gpu-operator
      url: https://nvidia.github.io/gpu-operator

  kubeChart:
    kind: helmchart
    spec:
      name: kube-prometheus-stack
      url: https://prometheus-community.github.io/helm-charts

  kroChart:
    kind: helmchart
    spec:
      name: kro
      url: oci://ghcr.io/kro-run/kro

targets:
  updateCertManagerVersion:
    name: "Update cert-manager Chart version"
    kind: yaml
    scmid: github
    sourceid: certManagerChart
    spec:
      file: cert-manager/cert-manager/Chart.yaml
      key: $.version

  updateCertManagerDependency:
    name: "Update cert-manager dependency version"
    kind: yaml
    scmid: github
    sourceid: certManagerChart
    spec:
      file: cert-manager/cert-manager/Chart.yaml
      key: $.dependencies[0].version

  updateExternalDnsVersion:
    name: "Update external-dns Chart version"
    kind: yaml
    scmid: github
    sourceid: externalDnsChart
    spec:
      file: dns/external-dns/Chart.yaml
      key: $.version

  updateExternalDnsDependency:
    name: "Update external-dns dependency version"
    kind: yaml
    scmid: github
    sourceid: externalDnsChart
    spec:
      file: dns/external-dns/Chart.yaml
      key: $.dependencies[0].version

  updateLokiVersion:
    name: "Update loki Chart version"
    kind: yaml
    scmid: github
    sourceid: lokiChart
    spec:
      file: monitoring/loki/Chart.yaml
      key: $.version

  updateLokiDependency:
    name: "Update loki dependency version"
    kind: yaml
    scmid: github
    sourceid: lokiChart
    spec:
      file: monitoring/loki/Chart.yaml
      key: $.dependencies[0].version

  updatePromtailVersion:
    name: "Update promtail Chart version"
    kind: yaml
    scmid: github
    sourceid: promtailChart
    spec:
      file: monitoring/promtail/Chart.yaml
      key: $.version

  updatePromtailDependency:
    name: "Update promtail dependency version"
    kind: yaml
    scmid: github
    sourceid: promtailChart
    spec:
      file: monitoring/promtail/Chart.yaml
      key: $.dependencies[0].version

  updateGpuUperatorVersion:
    name: "Update promtail Chart version"
    kind: yaml
    scmid: github
    sourceid: gpuOperatorChart
    spec:
      file: default/gpu-operator/Chart.yaml
      key: $.version

  updateGpuUperatorDependency:
    name: "Update promtail dependency version"
    kind: yaml
    scmid: github
    sourceid: gpuOperatorChart
    spec:
      file: default/gpu-operator/Chart.yaml
      key: $.dependencies[0].version

  updatekubeVersion:
    name: "Update promtail Chart version"
    kind: yaml
    scmid: github
    sourceid: kubeChart
    spec:
      file: monitoring/kube/Chart.yaml
      key: $.version

  updatekubeDependency:
    name: "Update promtail dependency version"
    kind: yaml
    scmid: github
    sourceid: kubeChart
    spec:
      file: monitoring/kube/Chart.yaml
      key: $.dependencies[0].version

  runScriptWhenKubeChanges:
    name: "Run script after kube chart update"
    kind: shell
    scmid: github
    sourceid: kubeChart
    spec:
      command: ./monitoring/kube/run_on_updates.sh

  updatekroVersion:
    name: "Update promtail Chart version"
    kind: yaml
    scmid: github
    sourceid: kroChart
    spec:
      file: kro/kro/Chart.yaml
      key: $.version

  updatekroDependency:
    name: "Update promtail dependency version"
    kind: yaml
    scmid: github
    sourceid: kroChart
    spec:
      file: kro/kro/Chart.yaml
      key: $.dependencies[0].version

actions:
  default:
    kind: github/pullrequest
    scmid: github
    title: "chore: bump Helm chart versions"
    spec:
      labels:
        - automated
        - helm
      description: |
        This pull request updates the version of Helm chart dependencies defined in Chart.yaml files.
        Changes were generated automatically using Updatecli.