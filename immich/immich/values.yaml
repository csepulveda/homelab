immich:
  server:
    controller:
      replicas: 1
    #runtimeClassName: nvidia
    #nodeSelector:
    #  nvidia.com/gpu.deploy.driver: "true"
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi" 
    ingress:
      main:
        enabled: true
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt
          external-dns.alpha.kubernetes.io/target: router.csepulveda.net
          nginx.ingress.kubernetes.io/proxy-body-size: "0"
        hosts:
          - host: immich.csepulveda.net
            paths:
              - path: "/"
        tls:
          - hosts:
            - immich.csepulveda.net
            secretName: immich.csepulveda.net-tls
      
  machine-learning:
    controller:
      replicas: 1
    image:
      repository: ghcr.io/immich-app/immich-machine-learning
      pullPolicy: IfNotPresent
      tag: v1.141.1
      #tag: v1.135.3-cuda
      #tag: v1.97.0-cuda #https://github.com/immich-app/immich/issues/8570
    #runtimeClassName: nvidia
    #nodeSelector:
    #  nvidia.com/gpu.deploy.driver: "true"
    env:
      TRANSFORMERS_CACHE: /cache
      MACHINE_LEARNING_HTTP_KEEPALIVE_TIMEOUT_S: 0
      IMMICH_LOG_LEVEL: debug
      ORT_DISABLE_MIMALLOC: "1"
    persistence:
      cache:
        enabled: true
        size: 10Gi
        type: emptyDir
        accessMode: ReadWriteMany
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"

  image:
    tag: v1.141.1
  immich:
    metrics:
      enabled: true
    persistence:
      library:
        existingClaim: immich-backup

  redis:
    enabled: true
    master:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 1

  env:
    - name: IMMICH_TELEMETRY_INCLUDE
      value: all
    - name: IMMICH_API_METRICS_PORT
      value: 8081
    - name: IMMICH_MICROSERVICES_METRICS_PORT
      value: 8082
    - name: IMMICH_METRICS
      value: true
    - name: REDIS_HOSTNAME
      value: immich-redis-master
    - name: DB_HOSTNAME
      valueFrom:
        secretKeyRef:
          name: immich-pg-app
          key: host
    - name: DB_DATABASE_NAME
      valueFrom:
        secretKeyRef:
          name: immich-pg-app
          key: dbname
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: immich-pg-app
          key: password
    - name: DB_USERNAME
      valueFrom:
        secretKeyRef:
          name: immich-pg-app
          key: username
